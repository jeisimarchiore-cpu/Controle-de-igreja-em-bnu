<!DOCTYPE html>
<html lang="pt-br" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Igrejas - Santa Catarina</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body { font-family: 'Poppins', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .slide-in-left { animation: slideInLeft 0.4s cubic-bezier(0.250, 0.460, 0.450, 0.940) both; }
        @keyframes slideInLeft { 0% { transform: translateX(-100%); opacity: 0; } 100% { transform: translateX(0); opacity: 1; } }
        @media (max-width: 768px) {
            #side-panel { transition: transform 0.3s ease-in-out; }
            #side-panel.hidden-mobile { transform: translateX(-100%); }
        }
        /* Ajuste para o mapa dentro do modal do Leaflet */
        .leaflet-container { z-index: 0; }
    </style>
</head>
<body class="h-full bg-slate-50 antialiased overflow-hidden text-slate-800">

    <div id="app-container" class="h-full w-full relative flex">

        <!-- PAINEL LATERAL -->
        <aside id="side-panel" class="absolute md:relative z-20 w-full md:w-[380px] h-full bg-white shadow-lg flex flex-col transition-transform slide-in-left">
            <header class="p-4 border-b border-slate-200 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <i class="fa fa-church text-2xl text-sky-600"></i>
                    <div>
                        <h1 class="text-lg font-bold text-slate-900">Portal de Igrejas</h1>
                        <p class="text-xs text-slate-500">Encontre um lugar de comunidade em Santa Catarina</p>
                    </div>
                </div>
                 <p id="church-count-display" class="text-xs text-slate-500 mt-2"></p>
            </header>

            <div class="p-4 flex-shrink-0 border-b border-slate-200 space-y-3">
                <div class="relative">
                    <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="search-input" placeholder="Pesquisar por nome..." class="w-full bg-slate-100 rounded-md pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <select id="city-filter" class="col-span-2 bg-slate-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
                    <select id="denomination-filter" class="w-full bg-slate-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
                    <select id="neighborhood-filter" class="w-full bg-slate-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
                </div>
            </div>

            <div id="church-list" class="flex-grow overflow-y-auto custom-scrollbar p-2"></div>

            <footer class="p-4 flex-shrink-0 border-t border-slate-200 flex items-center justify-between">
                <button id="add-church-btn" class="w-full bg-sky-600 text-white font-semibold py-2.5 rounded-md hover:bg-sky-700 transition flex items-center justify-center gap-2">
                    <i class="fa fa-plus"></i> Adicionar Igreja
                </button>
                 <button id="admin-btn" title="Ferramentas Administrativas" class="ml-2 flex-shrink-0 w-10 h-10 bg-slate-200 text-slate-600 rounded-md hover:bg-slate-300 transition flex items-center justify-center">
                    <i class="fa fa-cog"></i>
                </button>
            </footer>
        </aside>

        <!-- MAPA -->
        <main id="map-container" class="flex-grow h-full"></main>
        
        <button id="toggle-panel-btn" class="md:hidden absolute z-30 top-4 left-4 w-10 h-10 bg-white rounded-full shadow-md flex items-center justify-center text-slate-700">
            <i class="fa fa-bars"></i>
        </button>
    </div>
    
    <!-- MODAIS E OUTROS ELEMENTOS FLUTUANTES -->
    <div id="floating-elements-container">
        <div id="modal-container"></div>
        <div id="toast-container" class="fixed bottom-4 right-4 z-[9999] space-y-2"></div>

        <!-- BARRA DE PROGRESSO PARA IMPORTAÇÃO -->
        <div id="import-progress-bar" class="fixed bottom-4 right-4 z-50 bg-white p-3 rounded-lg shadow-lg w-full max-w-sm hidden transition-opacity duration-300 fade-in">
            <div class="flex justify-between items-center mb-1">
                <span id="import-progress-label" class="text-sm font-semibold text-slate-700">A importar...</span>
                <span id="import-progress-text" class="text-sm font-medium text-slate-600">0%</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2">
                <div id="import-progress-fill" class="bg-sky-600 h-2 rounded-full transition-all duration-300 ease-linear" style="width: 0%"></div>
            </div>
        </div>
    </div>
    
    <!-- OVERLAY DE CARREGAMENTO INICIAL -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[9999] flex flex-col items-center justify-center">
        <i class="fa fa-church fa-spin text-5xl text-sky-600"></i>
        <p id="loading-text" class="mt-4 text-slate-700 font-semibold">A carregar o portal...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, setDoc, deleteDoc, doc, getDocs, query, limit, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {

            const USER_FIREBASE_CONFIG = {
                apiKey: "AIzaSyDXmAZ-VW7Ti1_L5GPW0gNBkfGxMmxvypQ",
                authDomain: "controle-de-igrejas.firebaseapp.com",
                projectId: "controle-de-igrejas",
                storageBucket: "controle-de-igrejas.firebasestorage.app",
                messagingSenderId: "457376397325",
                appId: "1:457376397325:web:aacc6cef3e91390314fd44",
                measurementId: "G-PENC7PPT4M"
            };
            
            const ADMIN_PASSWORD = "2308";
            const MAP_CENTER = [-27.21, -49.64]; // Centro de SC
            const SANTA_CATARINA_BOUNDS = { minLat: -29.4, maxLat: -25.9, minLon: -53.8, maxLon: -48.3 };
            const CIDADES_SC = {
                "Blumenau": { lat: -26.9194, lon: -49.0661, zoom: 12 },
                "Florianópolis": { lat: -27.5954, lon: -48.5480, zoom: 12 },
                "Joinville": { lat: -26.3031, lon: -48.8456, zoom: 12 },
                "São José": { lat: -27.6146, lon: -48.6283, zoom: 13 },
                "Chapecó": { lat: -27.1002, lon: -52.6152, zoom: 13 },
                "Criciúma": { lat: -28.6775, lon: -49.3697, zoom: 13 },
                "Itajaí": { lat: -26.9075, lon: -48.6619, zoom: 13 },
                "Balneário Camboriú": { lat: -26.9905, lon: -48.6347, zoom: 14 },
                "Brusque": { lat: -27.0983, lon: -48.9133, zoom: 13 },
                "Gaspar": { lat: -26.9317, lon: -48.9558, zoom: 13 },
                "Indaial": { lat: -26.8961, lon: -49.2308, zoom: 13 },
                "Timbó": { lat: -26.8242, lon: -49.2719, zoom: 13 },
                "Pomerode": { lat: -26.7411, lon: -49.1764, zoom: 13 }
            };
            const BAIRROS_POR_CIDADE = {
                "Blumenau": ["Água Verde", "Badenfurt", "Boa Vista", "Bom Retiro", "Centro", "Da Glória", "Do Salto", "Escola Agrícola", "Fidélis", "Fortaleza", "Fortaleza Alta", "Garcia", "Itoupava Central", "Itoupava Norte", "Itoupava Seca", "Itoupavazinha", "Jardim Blumenau", "Nova Esperança", "Passo Manso", "Ponta Aguda", "Progresso", "Ribeirão Fresco", "Salto do Norte", "Salto Weissbach", "Testo Salto", "Tribess", "Valparaíso", "Velha", "Velha Central", "Velha Grande", "Victor Konder", "Vila Formosa", "Vila Itoupava", "Vila Nova", "Vorstadt"],
                "Itajaí": ["Cabeçudas", "Centro", "Cordeiros", "Dom Bosco", "Espinheiros", "Fazenda", "Imaruí", "Itaipava", "Murta", "Praia Brava", "Ressacada", "Salseiros", "São João", "São Judas", "São Vicente", "Vila Operária"],
                "Balneário Camboriú": ["Ariribá", "Centro", "Das Nações", "Dos Estados", "Dos Municípios", "Dos Pioneiros", "Praia dos Amores", "São Judas Tadeu", "Vila Real"],
                "Brusque": ["Águas Claras", "Azambuja", "Bateas", "Centro I", "Centro II", "Dom Joaquim", "Guarani", "Limeira", "Malucher", "Paquetá", "Poço Fundo", "Primeiro de Maio", "Rio Branco", "Santa Luzia", "Santa Rita", "Santa Terezinha", "São Luiz", "São Pedro", "Souza Cruz", "Tomaz Coelho", "Zantão"],
                "Gaspar": ["Alto Gasparinho", "Arraial D'Ouro", "Bateias", "Bela Vista", "Belchior", "Centro", "Coloninha", "Figueira", "Gaspar Grande", "Gasparinho", "Gaspar Mirim", "Lagoa", "Macucos", "Margem Esquerda", "Poço Grande", "Santa Terezinha", "Sete de Setembro"],
                "Indaial": ["Amizade", "Arapongas", "Benedito", "Caminho do Sol", "Carijós", "Centro", "Das Nações", "Dos Estados", "Encano", "Estrada das Areias", "João Paulo II", "Mulde", "Ribeirão das Pedras", "Rio Morto", "Sol", "Tapajós", "Warnow"],
                "Timbó": ["Araponguinhas", "Capitais", "Centro", "Das Nações", "Dos Estados", "Imigrantes", "Padre Martinho Stein", "Quinta dos Açores", "Tiroleses", "Vila Germer"],
                "Pomerode": ["Centro", "Ribeirão Areia", "Ribeirão Clara", "Ribeirão Luebke", "Testo Alto", "Testo Central", "Testo Rega", "Vila Nova"]
            };
            const DENOMINATIONS = ['Católica', 'Luterana', 'Batista', 'Assembleia de Deus', 'Outra Evangélica', 'Outra'];
            const DIAS_SEMANA = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];

            let state = { allChurches: [], filteredChurches: [], map: null, db: null, igrejasCollectionRef: null, selectedChurchId: null, isLoaded: false, loadingTimeout: null };

            const debounce = (func, delay) => {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            };

            // --- MÓDULO PRINCIPAL ---
            const App = {
                init() {
                    UI.showLoading('A inicializar...');
                    state.loadingTimeout = setTimeout(() => {
                        if (!state.isLoaded) UI.showError('A aplicação demorou a responder', '', true);
                    }, 10000);

                    if (!USER_FIREBASE_CONFIG?.apiKey) {
                        return UI.showError("Configuração Incompleta", "Por favor, cole as credenciais do seu projeto Firebase no ficheiro HTML.");
                    }
                    
                    try {
                        const firebaseApp = initializeApp(USER_FIREBASE_CONFIG);
                        state.db = getFirestore(firebaseApp);
                        state.igrejasCollectionRef = collection(state.db, "igrejas");
                        
                        const auth = getAuth(firebaseApp);
                        signInAnonymously(auth)
                            .then(() => this.onReady())
                            .catch(err => UI.showError("Erro de Autenticação", `Verifique os seus 'Domínios autorizados' no Firebase. Erro: ${err.message}`));
                    } catch (error) {
                        UI.showError("Erro Crítico na Inicialização", `Verifique as credenciais. Detalhe: ${error.message}`);
                    }
                },

                onReady() {
                    this.initMap();
                    this.fetchChurches();
                    this.setupEventListeners();
                },

                initMap() {
                    state.map = L.map('map-container').setView(MAP_CENTER, 8);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(state.map);
                },

                fetchChurches() {
                    onSnapshot(state.igrejasCollectionRef, (snapshot) => {
                        state.allChurches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        UI.updateFilters();
                        this.filterAndRender();
                        UI.hideLoading();
                    }, (error) => {
                        UI.showError("Erro de Permissão", `A sua base de dados bloqueou o acesso. Verifique as suas Regras de Segurança.`);
                    });
                },

                filterAndRender() {
                    const searchTerm = document.getElementById('search-input').value.toLowerCase();
                    const city = document.getElementById('city-filter').value;
                    const denomination = document.getElementById('denomination-filter').value;
                    const neighborhood = document.getElementById('neighborhood-filter').value;

                    state.filteredChurches = state.allChurches.filter(church => {
                        const matchesSearch = !searchTerm || (church.name || '').toLowerCase().includes(searchTerm);
                        const matchesCity = !city || church.city === city;
                        const matchesDenomination = !denomination || church.denomination === denomination;
                        const matchesNeighborhood = !neighborhood || church.neighborhood === neighborhood;
                        return matchesSearch && matchesCity && matchesDenomination && matchesNeighborhood;
                    }).sort((a,b) => (a.name || '').localeCompare(b.name || ''));
                    
                    UI.renderChurchList(state.filteredChurches);
                    this.renderMarkers();
                },
                
                renderMarkers() {
                    state.map.eachLayer(layer => { if (layer instanceof L.Marker) state.map.removeLayer(layer); });
                    state.filteredChurches.forEach(church => {
                        if (church.coords) {
                            const marker = L.marker(church.coords).addTo(state.map);
                            marker.on('click', () => this.selectChurch(church.id));
                        }
                    });
                },

                selectChurch(id) {
                    const church = state.allChurches.find(c => c.id === id);
                    if (church) {
                        state.selectedChurchId = id;
                        state.map.setView(church.coords, 16);
                        UI.Modals.openDetails(church);
                    }
                },

                setupEventListeners() {
                    document.getElementById('search-input').addEventListener('input', () => this.filterAndRender());
                    document.getElementById('city-filter').addEventListener('change', (e) => {
                        const city = e.target.value;
                        if (city && CIDADES_SC[city]) {
                            state.map.setView([CIDADES_SC[city].lat, CIDADES_SC[city].lon], CIDADES_SC[city].zoom);
                        }
                        UI.updateFilters();
                        this.filterAndRender();
                    });
                    document.getElementById('denomination-filter').addEventListener('change', () => this.filterAndRender());
                    document.getElementById('neighborhood-filter').addEventListener('change', async (e) => {
                        const neighborhood = e.target.value;
                        const city = document.getElementById('city-filter').value;
                        
                        UI.updateFilters(); // Atualiza as denominações ao mudar o bairro

                        if (neighborhood && city) {
                            UI.showLoading('A localizar bairro...');
                            const coords = await API.geocodeAddress(`${neighborhood}, ${city}, Santa Catarina`);
                            UI.hideLoading();
                            if (coords) {
                                state.map.setView([coords.lat, coords.lon], 15);
                            }
                        }
                        this.filterAndRender();
                    });
                    document.getElementById('toggle-panel-btn').addEventListener('click', () => {
                        document.getElementById('side-panel').classList.toggle('hidden-mobile');
                    });
                    document.getElementById('add-church-btn').addEventListener('click', () => UI.Modals.openAddEdit());
                    document.getElementById('admin-btn').addEventListener('click', () => UI.Modals.openAdmin());
                }
            };

            // --- MÓDULO DA UI E MODAIS ---
            const UI = {
                showLoading: (message) => { document.getElementById('loading-overlay').classList.remove('hidden'); document.getElementById('loading-text').textContent = message; },
                hideLoading: () => { state.isLoaded = true; clearTimeout(state.loadingTimeout); document.getElementById('loading-overlay').classList.add('hidden'); },
                showError: (title, message, isTimeout = false) => {
                    clearTimeout(state.loadingTimeout);
                    const overlay = document.getElementById('loading-overlay');
                     if (isTimeout) {
                        const authUrl = `https://console.firebase.google.com/project/${USER_FIREBASE_CONFIG.projectId}/authentication/settings`;
                        message = `A aplicação demorou demasiado tempo a responder. Isto acontece quando o domínio do site não está autorizado.<br><br>
                        <b>1. <a href="${authUrl}" target="_blank" class="text-sky-600 underline font-semibold">Clique aqui para abrir as configurações de autenticação.</a></b><br>
                        2. Clique em "Adicionar domínio" e insira: <b>${window.location.hostname}</b>`;
                    }
                    overlay.innerHTML = `<div class="text-center p-8 max-w-lg mx-auto bg-white rounded-lg shadow-xl border border-red-200"><i class="fa fa-times-circle text-6xl text-red-500"></i><h2 class="mt-4 text-2xl font-bold text-slate-800">${title}</h2><p class="mt-2 text-slate-600 text-left">${message}</p></div>`;
                    overlay.classList.remove('hidden');
                },
                renderChurchList: (churches) => {
                    const listEl = document.getElementById('church-list');
                    const countDisplay = document.getElementById('church-count-display');
                    countDisplay.innerHTML = `A exibir <strong>${churches.length}</strong> de <strong>${state.allChurches.length}</strong> locais.`;

                    listEl.innerHTML = '';
                    if (churches.length === 0) { listEl.innerHTML = `<div class="p-4 text-center text-slate-500">Nenhuma igreja encontrada.</div>`; return; }
                    churches.forEach(church => {
                        const card = document.createElement('div');
                        card.className = 'p-3 border-b border-slate-100 hover:bg-sky-50 cursor-pointer transition';
                        card.dataset.id = church.id;
                        card.innerHTML = `<h3 class="font-semibold text-slate-800">${church.name || 'Igreja sem nome'}</h3><p class="text-sm text-slate-500">${church.address || 'Endereço não informado'}</p>`;
                        card.addEventListener('click', () => {
                            App.selectChurch(church.id);
                            if (window.innerWidth < 768) document.getElementById('side-panel').classList.add('hidden-mobile');
                        });
                        listEl.appendChild(card);
                    });
                },
                updateFilters: () => {
                    const cityFilter = document.getElementById('city-filter');
                    const denFilter = document.getElementById('denomination-filter');
                    const neiFilter = document.getElementById('neighborhood-filter');
                    const selectedCity = cityFilter.value;
                    const selectedNeighborhood = neiFilter.value;

                    // Cidades
                    if (cityFilter.options.length <= 1) { // Só preenche uma vez para manter a seleção do utilizador
                         cityFilter.innerHTML = '<option value="">Todas as Cidades</option>' + Object.keys(CIDADES_SC).sort().map(c => `<option value="${c}">${c}</option>`).join('');
                    }
                    
                    // Bairros (atualiza sempre que a cidade muda)
                    const neighborhoods = BAIRROS_POR_CIDADE[selectedCity] || [];
                    neiFilter.innerHTML = '<option value="">Todos os Bairros</option>' + neighborhoods.map(n => `<option value="${n}">${n}</option>`).join('');
                    neiFilter.value = selectedNeighborhood; // Tenta manter o bairro selecionado se existir na nova lista
                    neiFilter.disabled = !selectedCity;

                    // Denominações (dinâmico)
                    let relevantChurches = state.allChurches;
                    if (selectedCity) relevantChurches = relevantChurches.filter(c => c.city === selectedCity);
                    if (selectedNeighborhood) relevantChurches = relevantChurches.filter(c => c.neighborhood === selectedNeighborhood);
                    const denominations = [...new Set(relevantChurches.map(c => c.denomination).filter(Boolean))].sort();
                    denFilter.innerHTML = '<option value="">Todas as Denominações</option>' + denominations.map(d => `<option value="${d}">${d}</option>`).join('');
                },
                showToast: (message, isError = false) => {
                    const toastContainer = document.getElementById('toast-container');
                    const toast = document.createElement('div');
                    toast.className = `p-3 rounded-md shadow-md text-white fade-in ${isError ? 'bg-red-500' : 'bg-green-500'}`;
                    toast.textContent = message;
                    toastContainer.appendChild(toast);
                    setTimeout(() => {
                        toast.remove();
                    }, 4000);
                },
                ProgressBar: {
                    show(label) {
                        const bar = document.getElementById('import-progress-bar');
                        bar.classList.remove('hidden');
                        this.update(0, label);
                    },
                    hide() {
                        setTimeout(() => document.getElementById('import-progress-bar').classList.add('hidden'), 3000);
                    },
                    update(percentage, label) {
                        const p = Math.round(percentage);
                        const bar = document.getElementById('import-progress-bar');
                        bar.querySelector('#import-progress-fill').style.width = `${p}%`;
                        bar.querySelector('#import-progress-text').textContent = `${p}%`;
                        if (label) bar.querySelector('#import-progress-label').textContent = label;
                    }
                },
                Modals: {
                    _createModal(id, content, maxWidth = 'max-w-lg') {
                        const modal = document.createElement('div');
                        modal.id = id;
                        modal.className = 'fixed inset-0 bg-black/60 z-40 hidden items-center justify-center p-4 fade-in';
                        modal.innerHTML = `<div class="bg-white rounded-lg shadow-2xl w-full ${maxWidth} flex flex-col max-h-[90vh]">${content}</div>`;
                        document.getElementById('modal-container').appendChild(modal);
                        modal.querySelector('.close-modal-btn')?.addEventListener('click', () => modal.remove());
                        return modal;
                    },
                    openDetails(church) {
                        let scheduleHtml = (church.schedule || []).map(s => {
                            const timeText = s.endTime ? `${s.startTime} - ${s.endTime}` : s.startTime;
                            return `<div class="flex justify-between text-sm py-1.5 border-b border-slate-100"><span class="font-medium text-slate-600">${s.day}</span><span class="text-slate-800">${timeText}</span></div>`;
                        }).join('') || '<p class="text-sm text-slate-500">Horários não informados.</p>';

                        const content = `
                            <header class="p-4 bg-slate-50 rounded-t-lg border-b flex justify-between items-start">
                                <div><h2 class="text-xl font-bold text-slate-900">${church.name}</h2><p class="text-sm text-slate-600">${church.address}</p></div>
                                <button class="close-modal-btn text-2xl text-slate-400 hover:text-slate-800">&times;</button>
                            </header>
                            <div class="p-4 custom-scrollbar overflow-y-auto">
                                <div class="mb-4"><h4 class="font-semibold mb-2">Horários</h4>${scheduleHtml}</div>
                                <div class="mb-4"><h4 class="font-semibold mb-2">Contacto</h4><p class="text-sm text-slate-600"><strong>Líder:</strong> ${church.leader || 'Não informado'}</p><p class="text-sm text-slate-600"><strong>Telefone:</strong> ${church.phone || 'Não informado'}</p><p class="text-sm text-slate-600"><strong>Website:</strong> ${church.website ? `<a href="${church.website}" target="_blank" class="text-sky-600 hover:underline">Visitar</a>` : 'Não informado'}</p></div>
                            </div>
                            <footer class="p-4 border-t flex gap-2">
                                 <a href="https://www.google.com/maps/dir/?api=1&destination=${church.coords[0]},${church.coords[1]}" target="_blank" class="flex-1 text-center bg-sky-600 text-white font-semibold py-2 rounded-md hover:bg-sky-700 transition flex items-center justify-center gap-2"><i class="fa fa-route"></i> Rota</a>
                                 <a href="https://www.google.com/maps?q&layer=c&cbll=${church.coords[0]},${church.coords[1]}" target="_blank" class="flex-1 text-center bg-amber-500 text-white font-semibold py-2 rounded-md hover:bg-amber-600 transition flex items-center justify-center gap-2"><i class="fa fa-street-view"></i> Ver Rua</a>
                                 <button class="edit-btn flex-1 bg-slate-200 font-semibold py-2 rounded-md hover:bg-slate-300">Editar</button>
                            </footer>`;
                        const modal = this._createModal('details-modal', content);
                        modal.classList.remove('hidden');
                        modal.querySelector('.edit-btn').addEventListener('click', () => { modal.remove(); this.openAddEdit(church); });
                    },
                    openAddEdit(church = {}) {
                        const isEditing = !!church.id;
                        
                        let timeOptionsHtml = '';
                        for (let h = 7; h < 23; h++) {
                            for (let m = 0; m < 60; m+=30) {
                                const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                                timeOptionsHtml += `<option value="${time}">${time}</option>`;
                            }
                        }

                        const scheduleHtml = (church.schedule || [{day: '', startTime: '', endTime: ''}]).map((s, i) => {
                            const dayOptions = DIAS_SEMANA.map(dia => `<option value="${dia}" ${s.day === dia ? 'selected' : ''}>${dia}</option>`).join('');
                            const startTimeOptions = timeOptionsHtml.replace(`value="${s.startTime}"`, `value="${s.startTime}" selected`);
                            const endTimeOptions = timeOptionsHtml.replace(`value="${s.endTime}"`, `value="${s.endTime}" selected`);

                            return `
                            <div class="flex items-center gap-2 schedule-row">
                                <select class="w-1/3 border-slate-300 rounded-md text-sm schedule-day">
                                    <option value="">Selecione o dia</option>
                                    ${dayOptions}
                                </select>
                                <div class="flex items-center gap-1 w-2/3">
                                    <select class="w-1/2 border-slate-300 rounded-md text-sm schedule-start-time">
                                        <option value="">Início</option>
                                        ${startTimeOptions}
                                    </select>
                                    <span class="text-slate-500 text-xs">às</span>
                                    <select class="w-1/2 border-slate-300 rounded-md text-sm schedule-end-time">
                                        <option value="">Fim</option>
                                        ${endTimeOptions}
                                    </select>
                                </div>
                                <button type="button" class="${i === 0 ? 'add-schedule-btn' : 'remove-schedule-btn'} text-sm">${i === 0 ? '<i class="fa fa-plus text-green-500"></i>' : '<i class="fa fa-trash text-red-500"></i>'}</button>
                            </div>`;
                        }).join('');

                        const content = `
                            <header class="p-4 border-b"><h2 class="text-xl font-bold">${isEditing ? 'Editar' : 'Adicionar'} Igreja</h2></header>
                            <div class="p-4 custom-scrollbar overflow-y-auto space-y-6">
                                <fieldset class="border-t pt-4"><legend class="text-sm font-semibold text-sky-700 px-2 -ml-2">Informações Principais</legend><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2"><div><label class="text-sm font-medium">Nome*</label><input id="form-name" type="text" class="w-full border-slate-300 rounded-md" value="${church.name || ''}"></div><div><label class="text-sm font-medium">Denominação</label><select id="form-denomination" class="w-full border-slate-300 rounded-md">${DENOMINATIONS.map(d => `<option value="${d}" ${church.denomination === d ? 'selected' : ''}>${d}</option>`)}</select></div><div><label class="text-sm font-medium">Cidade*</label><select id="form-city" class="w-full border-slate-300 rounded-md">${Object.keys(CIDADES_SC).map(c => `<option value="${c}" ${church.city === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div></div></fieldset>
                                <fieldset class="border-t pt-4"><legend class="text-sm font-semibold text-sky-700 px-2 -ml-2">Horários de Atividades</legend><div id="schedule-container" class="mt-2 space-y-2">${scheduleHtml}</div></fieldset>
                                <fieldset class="border-t pt-4"><legend class="text-sm font-semibold text-sky-700 px-2 -ml-2">Contacto</legend><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2"><div><label class="text-sm font-medium">Líder</label><input id="form-leader" type="text" class="w-full border-slate-300 rounded-md" value="${church.leader || ''}"></div><div><label class="text-sm font-medium">Telefone</label><input id="form-phone" type="text" class="w-full border-slate-300 rounded-md" value="${church.phone || ''}"></div><div class="md:col-span-2"><label class="text-sm font-medium">Website</label><input id="form-website" type="text" class="w-full border-slate-300 rounded-md" value="${church.website || ''}"></div></div></fieldset>
                                <fieldset class="border-t pt-4"><legend class="text-sm font-semibold text-sky-700 px-2 -ml-2">Localização no Mapa*</legend>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                        <input id="form-cep" type="text" placeholder="Digite o CEP..." class="border-slate-300 rounded-md text-sm">
                                        <input id="form-rua" type="text" placeholder="Ou digite a Rua e Número..." class="border-slate-300 rounded-md text-sm">
                                    </div>
                                    <p class="text-xs text-slate-500 my-2">O endereço será procurado automaticamente. Em alternativa, clique no mapa abaixo.</p>
                                    <div id="form-map" class="h-64 rounded-md"></div>
                                    <input id="form-lat" type="hidden" value="${church.coords?.[0] || ''}"><input id="form-lng" type="hidden" value="${church.coords?.[1] || ''}">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                        <div><label class="text-sm font-medium">Endereço Completo</label><input id="form-address" type="text" class="w-full border-slate-300 rounded-md bg-slate-50" value="${church.address || ''}" readonly></div>
                                        <div><label class="text-sm font-medium">Bairro</label><input id="form-neighborhood" type="text" class="w-full border-slate-300 rounded-md bg-slate-50" value="${church.neighborhood || ''}" readonly></div>
                                    </div>
                                </fieldset>
                            </div>
                            <footer class="p-4 border-t flex justify-end gap-2">
                                <button class="close-modal-btn bg-slate-200 font-semibold py-2 px-4 rounded-md">Cancelar</button>
                                <button id="save-btn" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-md">Salvar</button>
                            </footer>`;

                        const modal = this._createModal('add-edit-modal', content, 'max-w-3xl');
                        modal.classList.remove('hidden');

                        const formMap = L.map('form-map').setView(church.coords || MAP_CENTER, church.coords ? 17 : 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(formMap);
                        let marker = church.coords ? L.marker(church.coords).addTo(formMap) : null;
                        
                        const updateLocation = (lat, lng, zoom = 17) => {
                             document.getElementById('form-lat').value = lat;
                             document.getElementById('form-lng').value = lng;
                             formMap.setView([lat, lng], zoom);
                             if (marker) marker.setLatLng([lat, lng]);
                             else marker = L.marker([lat, lng]).addTo(formMap);
                             API.fetchAddressForCoords(lat, lng).then(addr => {
                                if (addr) {
                                    document.getElementById('form-address').value = addr.address;
                                    document.getElementById('form-neighborhood').value = addr.neighborhood;
                                }
                             });
                        };
                        
                        const handleAddressSearch = debounce(async () => {
                            const cep = modal.querySelector('#form-cep').value;
                            const rua = modal.querySelector('#form-rua').value;
                            let query = '';

                            if (cep && cep.replace(/\D/g, '').length === 8) {
                                const viaCepData = await API.fetchCEP(cep);
                                if (viaCepData) query = `${viaCepData.logradouro}, ${viaCepData.bairro}, ${viaCepData.localidade}`;
                            } else if (rua.length > 5) {
                                query = `${rua}, ${document.getElementById('form-city').value}`;
                            } else { return; }

                            const coords = await API.geocodeAddress(query + ', Santa Catarina');
                            if (coords) updateLocation(coords.lat, coords.lon);
                        }, 800);

                        formMap.on('click', e => updateLocation(e.latlng.lat, e.latlng.lng));
                        modal.querySelector('#form-cep').addEventListener('input', handleAddressSearch);
                        modal.querySelector('#form-rua').addEventListener('input', handleAddressSearch);
                        
                        modal.querySelector('#schedule-container').addEventListener('click', e => {
                            if (e.target.closest('.add-schedule-btn')) {
                                const container = document.getElementById('schedule-container');
                                const newRow = container.querySelector('.schedule-row').cloneNode(true);
                                newRow.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
                                newRow.querySelector('button').innerHTML = '<i class="fa fa-trash text-red-500"></i>';
                                newRow.querySelector('button').classList.replace('add-schedule-btn', 'remove-schedule-btn');
                                container.appendChild(newRow);
                            } else if (e.target.closest('.remove-schedule-btn')) {
                                e.target.closest('.schedule-row').remove();
                            }
                        });

                        modal.querySelector('#save-btn').addEventListener('click', async () => {
                            const lat = parseFloat(document.getElementById('form-lat').value);
                            const lng = parseFloat(document.getElementById('form-lng').value);
                            const schedule = [...document.querySelectorAll('.schedule-row')].map(row => ({ 
                                day: row.querySelector('.schedule-day').value, 
                                startTime: row.querySelector('.schedule-start-time').value,
                                endTime: row.querySelector('.schedule-end-time').value 
                            })).filter(s => s.day && s.startTime);
                            const data = { name: document.getElementById('form-name').value, city: document.getElementById('form-city').value, address: document.getElementById('form-address').value, neighborhood: document.getElementById('form-neighborhood').value, denomination: document.getElementById('form-denomination').value, schedule: schedule, leader: document.getElementById('form-leader').value, phone: document.getElementById('form-phone').value, website: document.getElementById('form-website').value, coords: (lat && lng) ? [lat, lng] : null };
                            
                            UI.showLoading('A salvar...');
                            try {
                                if (isEditing) await setDoc(doc(state.igrejasCollectionRef, church.id), data);
                                else await addDoc(state.igrejasCollectionRef, data);
                                modal.remove();
                            } catch (err) { alert('Erro ao salvar.'); } finally { UI.hideLoading(); }
                        });
                    },
                    openAdmin() {
                        const content = `
                            <header class="p-4 border-b flex justify-between items-center"><h2 class="text-xl font-bold">Ferramentas Administrativas</h2><button class="close-modal-btn text-2xl text-slate-400 hover:text-slate-800">&times;</button></header>
                            <div class="p-4 space-y-3">
                                <button id="import-btn" class="w-full text-left p-3 rounded-md bg-slate-100 hover:bg-slate-200 transition">Assistente de Importação Inteligente</button>
                                <button id="cleanup-btn" class="w-full text-left p-3 rounded-md bg-slate-100 hover:bg-slate-200 transition">Limpar Locais Fora de SC</button>
                                <button id="clear-all-btn" class="w-full text-left p-3 rounded-md bg-red-50 text-red-700 hover:bg-red-100 transition">Apagar TODA a Base de Dados</button>
                                <button id="test-connection-btn" class="w-full text-left p-3 rounded-md bg-slate-100 hover:bg-slate-200 transition mt-4">Testar Ligação</button>
                            </div>`;
                        const modal = this._createModal('admin-modal', content, 'max-w-md');
                        modal.classList.remove('hidden');
                        modal.querySelector('#import-btn').addEventListener('click', () => { modal.remove(); this.openImportAssistant(); });
                        modal.querySelector('#cleanup-btn').addEventListener('click', () => { modal.remove(); this.openConfirm({ action: 'cleanup' }); });
                        modal.querySelector('#clear-all-btn').addEventListener('click', () => { modal.remove(); this.openConfirm({ action: 'clearAll' }); });
                        modal.querySelector('#test-connection-btn').addEventListener('click', async () => { UI.showLoading('A testar...'); try { await getDocs(query(state.igrejasCollectionRef, limit(1))); UI.showToast('Ligação com Firebase OK!'); } catch(e) { UI.showToast(`Falha na ligação: ${e.message}`, true); } finally { UI.hideLoading(); }});
                    },
                    openConfirm({ action }) {
                        const options = {
                            cleanup: { title: 'Limpar Locais Fora de SC', message: 'Isto irá apagar igrejas fora de Santa Catarina. Requer senha.' },
                            clearAll: { title: 'Apagar TUDO', message: 'Isto é irreversível e irá apagar TODAS as igrejas. Requer senha.' }
                        };
                        const content = `
                            <div class="p-6 text-center">
                                <h3 class="text-lg font-bold">${options[action].title}</h3>
                                <p class="mt-2 text-sm text-slate-600">${options[action].message}</p>
                                <div class="mt-4"><input type="password" id="admin-password" placeholder="Senha de Administrador" class="w-full border-slate-300 rounded-lg text-center"></div>
                                <div class="mt-6 flex justify-center gap-4">
                                    <button class="close-modal-btn px-6 py-2 bg-slate-200 font-semibold rounded-md">Cancelar</button>
                                    <button id="confirm-action-btn" class="px-6 py-2 bg-sky-600 text-white font-semibold rounded-md">Confirmar</button>
                                </div>
                            </div>`;
                        const modal = this._createModal('confirm-modal', content, 'max-w-sm');
                        modal.classList.remove('hidden');
                        modal.querySelector('#confirm-action-btn').addEventListener('click', () => {
                            if (document.getElementById('admin-password').value === ADMIN_PASSWORD) {
                                modal.remove();
                                if (action === 'cleanup') Admin.cleanupOutsideSC();
                                if (action === 'clearAll') Admin.clearAll();
                            } else {
                                alert('Senha incorreta!');
                            }
                        });
                    },
                    openImportAssistant() {
                        let step = 1;
                        let searchResults = [];

                        const render = () => {
                            let content = '';
                            if (step === 1) {
                                content = `
                                    <header class="p-4 border-b"><h2 class="text-xl font-bold">Assistente de Importação Inteligente</h2></header>
                                    <div class="p-4 space-y-4">
                                        <p class="text-sm">O assistente irá procurar por locais de culto (igrejas, templos, etc.). Escolha um método de busca:</p>
                                        <button id="search-area-btn" class="w-full bg-blue-100 text-blue-800 font-semibold py-2 rounded-md hover:bg-blue-200 transition">1. Procurar na área visível do mapa</button>
                                        <div class="relative"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-300"></div></div><div class="relative flex justify-center text-sm"><span class="bg-white px-2 text-slate-500">Ou</span></div></div>
                                        <div><label class="text-sm font-medium">2. Procurar em Cidade/Bairro Específico</label>
                                            <div class="flex gap-2 mt-1">
                                                <select id="import-city" class="w-1/2 border-slate-300 rounded-md">${Object.keys(CIDADES_SC).map(c => `<option value="${c}">${c}</option>`).join('')}</select>
                                                <select id="import-neighborhood" class="w-1/2 border-slate-300 rounded-md"></select>
                                            </div>
                                        </div>
                                    </div>
                                    <footer class="p-4 border-t flex justify-end gap-2"><button class="close-modal-btn bg-slate-200 font-semibold py-2 px-4 rounded-md">Cancelar</button><button id="next-step-btn" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-md">Procurar no Local Específico</button></footer>`;
                            } else if (step === 2) {
                                const newResults = searchResults.filter(r => !r.isDuplicate);
                                content = `
                                    <header class="p-4 border-b"><h2 class="text-xl font-bold">Assistente de Importação - Passo 2</h2></header>
                                    <div class="p-4 space-y-4">
                                        <p class="text-sm">Encontrámos ${searchResults.length} resultado(s). ${newResults.length} são novos. Selecione os que deseja importar.</p>
                                        <div id="import-results" class="max-h-64 overflow-y-auto custom-scrollbar border rounded-md divide-y">
                                            ${searchResults.map((r, i) => `
                                                <div class="p-2 flex items-center gap-3 ${r.isDuplicate ? 'bg-slate-100 text-slate-400' : ''}">
                                                    <input type="checkbox" id="import-check-${i}" class="h-4 w-4" ${r.isDuplicate ? 'disabled' : 'checked'}>
                                                    <div>
                                                        <label for="import-check-${i}" class="font-semibold">${r.name}</label>
                                                        <p class="text-xs">${r.address}</p>
                                                        ${r.isDuplicate ? '<p class="text-xs text-amber-600">Possível duplicado já existente.</p>' : ''}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <footer class="p-4 border-t flex justify-between gap-2"><button id="prev-step-btn" class="bg-slate-200 font-semibold py-2 px-4 rounded-md">Voltar</button><button id="import-btn" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-md">Importar Selecionados</button></footer>`;
                            }
                            
                            const modal = this._createModal('import-modal', content, 'max-w-xl');
                            modal.classList.remove('hidden');

                            if (step === 1) {
                                const citySelect = modal.querySelector('#import-city');
                                const neighborhoodSelect = modal.querySelector('#import-neighborhood');
                                const updateNeighborhoods = () => {
                                    const city = citySelect.value;
                                    const neighborhoods = BAIRROS_POR_CIDADE[city] || [];
                                    neighborhoodSelect.innerHTML = '<option value="">Toda a cidade</option>' + neighborhoods.map(n => `<option value="${n}">${n}</option>`).join('');
                                };
                                updateNeighborhoods();
                                citySelect.addEventListener('change', updateNeighborhoods);

                                modal.querySelector('#next-step-btn').addEventListener('click', async () => {
                                    const city = citySelect.value;
                                    const neighborhood = neighborhoodSelect.value;
                                    modal.remove();
                                    UI.showLoading('A procurar...');
                                    searchResults = await Admin.scanMap(city, neighborhood);
                                    UI.hideLoading();
                                    step = 2;
                                    render();
                                });

                                modal.querySelector('#search-area-btn').addEventListener('click', async () => {
                                    modal.remove();
                                    UI.showLoading('A procurar na área visível...');
                                    searchResults = await Admin.scanMap(null, null, state.map.getBounds());
                                    UI.hideLoading();
                                    step = 2;
                                    render();
                                });
                            } else if (step === 2) {
                                modal.querySelector('#prev-step-btn').addEventListener('click', () => { modal.remove(); step = 1; render(); });
                                modal.querySelector('#import-btn').addEventListener('click', async () => {
                                    const toImport = [];
                                    searchResults.forEach((r, i) => {
                                        if (document.getElementById(`import-check-${i}`).checked) toImport.push(r);
                                    });
                                    modal.remove();
                                    if(toImport.length > 0) Admin.importChurches(toImport);
                                });
                            }
                        };
                        render();
                    }
                }
            };
            
            // --- MÓDULO DE ADMINISTRAÇÃO E API ---
            const Admin = {
                async scanMap(city, neighborhood = null, bounds = null) {
                    let params = new URLSearchParams({
                        format: 'jsonv2',
                        bounded: 1,
                        limit: 50,
                        amenity: 'place_of_worship',
                        countrycodes: 'br'
                    });

                    let cityForNewEntries = city;

                    if (bounds) {
                        const searchBounds = { minLon: Math.max(bounds.getWest(), SANTA_CATARINA_BOUNDS.minLon), minLat: Math.max(bounds.getSouth(), SANTA_CATARINA_BOUNDS.minLat), maxLon: Math.min(bounds.getEast(), SANTA_CATARINA_BOUNDS.maxLon), maxLat: Math.min(bounds.getNorth(), SANTA_CATARINA_BOUNDS.maxLat) };
                        params.set('viewbox', `${searchBounds.minLon},${searchBounds.maxLat},${searchBounds.maxLon},${searchBounds.minLat}`);
                        cityForNewEntries = 'Não especificada';
                    } else if (city && CIDADES_SC[city]) {
                        const cityBounds = CIDADES_SC[city];
                        params.set('viewbox', `${cityBounds.lon - 0.1},${cityBounds.lat + 0.1},${cityBounds.lon + 0.1},${cityBounds.lat - 0.1}`);
                        if (neighborhood) params.set('q', `${neighborhood}, ${city}, Santa Catarina`);
                    } else return [];
                    
                    const url = `https://nominatim.openstreetmap.org/search?${params.toString()}`;

                    try {
                        const response = await fetch(url);
                        const results = await response.json();
                        return results.map(r => {
                            const lat = parseFloat(r.lat);
                            const lon = parseFloat(r.lon);
                            const isDuplicate = state.allChurches.some(church => church.coords && Math.sqrt(Math.pow(church.coords[0] - lat, 2) + Math.pow(church.coords[1] - lon, 2)) < 0.0002);
                            return { name: r.display_name.split(',')[0], address: r.display_name, lat, lon, isDuplicate, city: cityForNewEntries };
                        });
                    } catch (e) { console.error("Erro ao escanear:", e); return []; }
                },
                async importChurches(churchesToImport) {
                    const total = churchesToImport.length;
                    UI.ProgressBar.show(`A importar 0 de ${total}...`);
                    let importedCount = 0;

                    for (const church of churchesToImport) {
                        const addr = await API.fetchAddressForCoords(church.lat, church.lon);
                        const city = church.city === 'Não especificada' ? (addr.city || 'Não especificada') : church.city;

                        await addDoc(state.igrejasCollectionRef, {
                            name: church.name,
                            city: city,
                            address: addr.address,
                            neighborhood: addr.neighborhood,
                            coords: [church.lat, church.lon],
                            denomination: 'Outra',
                            schedule: [], leader: '', phone: '', website: ''
                        });
                        importedCount++;
                        const percentage = (importedCount / total) * 100;
                        UI.ProgressBar.update(percentage, `A importar ${importedCount} de ${total}...`);
                    }
                    UI.ProgressBar.update(100, `Importação concluída!`);
                    UI.ProgressBar.hide();
                },
                async cleanupOutsideSC() {
                    UI.showLoading('A verificar dados...');
                    const toDelete = [];
                    state.allChurches.forEach(church => {
                        if (church.coords) {
                            const [lat, lon] = church.coords;
                            if (lat < SANTA_CATARINA_BOUNDS.minLat || lat > SANTA_CATARINA_BOUNDS.maxLat || lon < SANTA_CATARINA_BOUNDS.minLon || lon > SANTA_CATARINA_BOUNDS.maxLon) {
                                toDelete.push(church.id);
                            }
                        }
                    });

                    if (toDelete.length === 0) {
                        UI.hideLoading();
                        UI.showToast('Nenhum local fora de Santa Catarina encontrado.');
                        return;
                    }

                    UI.showLoading(`A remover ${toDelete.length} locais...`);
                    const batch = writeBatch(state.db);
                    toDelete.forEach(id => batch.delete(doc(state.igrejasCollectionRef, id)));
                    await batch.commit();
                    UI.hideLoading();
                    UI.showToast(`${toDelete.length} locais fora de Santa Catarina foram removidos.`);
                },
                async clearAll() {
                    UI.showLoading(`A apagar ${state.allChurches.length} locais...`);
                    const batch = writeBatch(state.db);
                    state.allChurches.forEach(church => batch.delete(doc(state.igrejasCollectionRef, church.id)));
                    await batch.commit();
                    UI.hideLoading();
                    UI.showToast('Todos os locais foram removidos com sucesso.', true);
                }
            };
            const API = {
                async fetchAddressForCoords(lat, lon) {
                    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;
                    try {
                        const res = await fetch(url);
                        const data = await res.json();
                        return {
                            address: data.display_name || '',
                            neighborhood: data.address?.suburb || data.address?.city_district || '',
                            city: data.address?.city || data.address?.town || data.address?.village || ''
                        };
                    } catch (e) { console.error("Erro no geocoding:", e); return null; }
                },
                async fetchCEP(cep) {
                    const url = `https://viacep.com.br/ws/${cep.replace(/\D/g, '')}/json/`;
                    try { const res = await fetch(url); const data = await res.json(); return data.erro ? null : data; } 
                    catch (e) { console.error("Erro ao buscar CEP:", e); return null; }
                },
                async geocodeAddress(addressQuery) {
                    const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(addressQuery)}&countrycodes=br&limit=1`;
                    try {
                        const res = await fetch(url);
                        const data = await res.json();
                        if (data && data.length > 0) {
                             const result = data[0];
                             const lat = parseFloat(result.lat);
                             const lon = parseFloat(result.lon);
                             if (lat >= SANTA_CATARINA_BOUNDS.minLat && lat <= SANTA_CATARINA_BOUNDS.maxLat && lon >= SANTA_CATARINA_BOUNDS.minLon && lon <= SANTA_CATARINA_BOUNDS.maxLon) {
                                return { lat, lon };
                             }
                        } 
                        return null;
                    } catch (e) { console.error("Erro no geocoding:", e); return null; }
                }
            };
            
            // --- INICIALIZAR A APLICAÇÃO ---
            App.init();
        });
    </script>
</body>
</html>

