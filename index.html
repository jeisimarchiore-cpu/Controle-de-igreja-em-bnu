<!DOCTYPE html>
<html lang="pt-br" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Igrejas - Santa Catarina</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body { font-family: 'Poppins', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .slide-in-left { animation: slideInLeft 0.4s cubic-bezier(0.250, 0.460, 0.450, 0.940) both; }
        @keyframes slideInLeft { 0% { transform: translateX(-100%); opacity: 0; } 100% { transform: translateX(0); opacity: 1; } }
        @media (max-width: 768px) {
            #side-panel { transition: transform 0.3s ease-in-out; }
            #side-panel.hidden-mobile { transform: translateX(-100%); }
        }
        .leaflet-container { z-index: 0; }

        @media print {
            body * { visibility: hidden; }
            #printable-report, #printable-report * { visibility: visible; }
            #printable-report { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="h-full bg-slate-50 antialiased overflow-hidden text-slate-800">

    <div id="app-container" class="h-full w-full relative flex">

        <!-- PAINEL LATERAL -->
        <aside id="side-panel" class="absolute md:relative z-20 w-full md:w-[380px] h-full bg-white shadow-lg flex flex-col transition-transform slide-in-left">
            <header class="p-4 border-b border-slate-200 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <i class="fa fa-church text-2xl text-sky-600"></i>
                    <div>
                        <h1 class="text-lg font-bold text-slate-900">Portal de Igrejas</h1>
                        <p class="text-xs text-slate-500">Encontre um lugar de comunidade em Santa Catarina</p>
                    </div>
                </div>
                 <p id="church-count-display" class="text-xs text-slate-500 mt-2"></p>
            </header>

            <div class="p-4 flex-shrink-0 border-b border-slate-200 space-y-3">
                <div class="relative">
                    <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="search-input" placeholder="Pesquisar por nome..." class="w-full bg-slate-100 rounded-md pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <select id="city-filter" class="col-span-2 bg-slate-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
                    <select id="neighborhood-filter" class="col-span-2 bg-slate-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
                </div>
            </div>

            <div id="church-list" class="flex-grow overflow-y-auto custom-scrollbar p-2"></div>

            <footer class="p-4 flex-shrink-0 border-t border-slate-200 flex items-center justify-between">
                <button id="add-church-btn" class="w-full bg-sky-600 text-white font-semibold py-2.5 rounded-md hover:bg-sky-700 transition flex items-center justify-center gap-2">
                    <i class="fa fa-plus"></i> Adicionar Igreja
                </button>
                 <button id="admin-btn" title="Ferramentas Administrativas" class="ml-2 flex-shrink-0 w-10 h-10 bg-slate-200 text-slate-600 rounded-md hover:bg-slate-300 transition flex items-center justify-center">
                    <i class="fa fa-cog"></i>
                </button>
            </footer>
        </aside>

        <!-- MAPA -->
        <main id="map-container" class="flex-grow h-full"></main>
        
        <button id="toggle-panel-btn" class="md:hidden absolute z-30 top-4 left-4 w-10 h-10 bg-white rounded-full shadow-md flex items-center justify-center text-slate-700">
            <i class="fa fa-bars"></i>
        </button>
    </div>
    
    <!-- MODAIS E OUTROS ELEMENTOS FLUTUANTES -->
    <div id="floating-elements-container">
        <div id="modal-container"></div>
        <div id="toast-container" class="fixed bottom-4 right-4 z-[9999] space-y-2"></div>
    </div>
    
    <!-- OVERLAY DE CARREGAMENTO INICIAL -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[9999] flex flex-col items-center justify-center">
        <i class="fa fa-church fa-spin text-5xl text-sky-600"></i>
        <p id="loading-text" class="mt-4 text-slate-700 font-semibold">A carregar o portal...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, setDoc, deleteDoc, doc, getDocs, query, limit, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {

            const USER_FIREBASE_CONFIG = {
                apiKey: "AIzaSyDXmAZ-VW7Ti1_L5GPW0gNBkfGxMmxvypQ",
                authDomain: "controle-de-igrejas.firebaseapp.com",
                projectId: "controle-de-igrejas",
                storageBucket: "controle-de-igrejas.firebasestorage.app",
                messagingSenderId: "457376397325",
                appId: "1:457376397325:web:aacc6cef3e91390314fd44",
                measurementId: "G-PENC7PPT4M"
            };
            
            const ADMIN_PASSWORD = "2308";
            const MAP_CENTER = [-27.21, -49.64]; // Centro de SC
            const SANTA_CATARINA_BOUNDS = { minLat: -29.4, maxLat: -25.9, minLon: -53.8, maxLon: -48.3 };
            const CIDADES_SC = {
                "Blumenau": { lat: -26.9194, lon: -49.0661, zoom: 12 },
                "Florianópolis": { lat: -27.5954, lon: -48.5480, zoom: 12 },
                "Joinville": { lat: -26.3031, lon: -48.8456, zoom: 12 },
                "São José": { lat: -27.6146, lon: -48.6283, zoom: 13 },
                "Chapecó": { lat: -27.1002, lon: -52.6152, zoom: 13 },
                "Criciúma": { lat: -28.6775, lon: -49.3697, zoom: 13 },
                "Itajaí": { lat: -26.9075, lon: -48.6619, zoom: 13 },
                "Balneário Camboriú": { lat: -26.9905, lon: -48.6347, zoom: 14 },
                "Brusque": { lat: -27.0983, lon: -48.9133, zoom: 13 },
                "Gaspar": { lat: -26.9317, lon: -48.9558, zoom: 13 },
                "Indaial": { lat: -26.8961, lon: -49.2308, zoom: 13 },
                "Timbó": { lat: -26.8242, lon: -49.2719, zoom: 13 },
                "Pomerode": { lat: -26.7411, lon: -49.1764, zoom: 13 }
            };
            const BAIRROS_POR_CIDADE = {
                "Blumenau": ["Água Verde", "Badenfurt", "Boa Vista", "Bom Retiro", "Centro", "Da Glória", "Do Salto", "Escola Agrícola", "Fidélis", "Fortaleza", "Fortaleza Alta", "Garcia", "Itoupava Central", "Itoupava Norte", "Itoupava Seca", "Itoupavazinha", "Jardim Blumenau", "Nova Esperança", "Passo Manso", "Ponta Aguda", "Progresso", "Ribeirão Fresco", "Salto do Norte", "Salto Weissbach", "Testo Salto", "Tribess", "Valparaíso", "Velha", "Velha Central", "Velha Grande", "Victor Konder", "Vila Formosa", "Vila Itoupava", "Vila Nova", "Vorstadt"],
                "Itajaí": ["Cabeçudas", "Centro", "Cordeiros", "Dom Bosco", "Espinheiros", "Fazenda", "Imaruí", "Itaipava", "Murta", "Praia Brava", "Ressacada", "Salseiros", "São João", "São Judas", "São Vicente", "Vila Operária"],
                "Balneário Camboriú": ["Ariribá", "Centro", "Das Nações", "Dos Estados", "Dos Municípios", "Dos Pioneiros", "Praia dos Amores", "São Judas Tadeu", "Vila Real"],
                "Brusque": ["Águas Claras", "Azambuja", "Bateas", "Centro I", "Centro II", "Dom Joaquim", "Guarani", "Limeira", "Malucher", "Paquetá", "Poço Fundo", "Primeiro de Maio", "Rio Branco", "Santa Luzia", "Santa Rita", "Santa Terezinha", "São Luiz", "São Pedro", "Souza Cruz", "Tomaz Coelho", "Zantão"],
                "Gaspar": ["Alto Gasparinho", "Arraial D'Ouro", "Bateias", "Bela Vista", "Belchior", "Centro", "Coloninha", "Figueira", "Gaspar Grande", "Gasparinho", "Gaspar Mirim", "Lagoa", "Macucos", "Margem Esquerda", "Poço Grande", "Santa Terezinha", "Sete de Setembro"],
                "Indaial": ["Amizade", "Arapongas", "Benedito", "Caminho do Sol", "Carijós", "Centro", "Das Nações", "Dos Estados", "Encano", "Estrada das Areias", "João Paulo II", "Mulde", "Ribeirão das Pedras", "Rio Morto", "Sol", "Tapajós", "Warnow"],
                "Timbó": ["Araponguinhas", "Capitais", "Centro", "Das Nações", "Dos Estados", "Imigrantes", "Padre Martinho Stein", "Quinta dos Açores", "Tiroleses", "Vila Germer"],
                "Pomerode": ["Centro", "Ribeirão Areia", "Ribeirão Clara", "Ribeirão Luebke", "Testo Alto", "Testo Central", "Testo Rega", "Vila Nova"]
            };
            const DENOMINATIONS = ['Católica', 'Luterana', 'Batista', 'Assembleia de Deus', 'Outra Evangélica', 'Outra'];
            const DIAS_SEMANA = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];

            let state = { allChurches: [], filteredChurches: [], map: null, db: null, igrejasCollectionRef: null, selectedChurchId: null, isLoaded: false, loadingTimeout: null, isCaptureMode: false };

            const debounce = (func, delay) => {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            };

            // --- MÓDULO PRINCIPAL ---
            const App = {
                init() {
                    UI.showLoading('A inicializar...');
                    state.loadingTimeout = setTimeout(() => {
                        if (!state.isLoaded) UI.showError('A aplicação demorou a responder', '', true);
                    }, 10000);

                    if (!USER_FIREBASE_CONFIG?.apiKey) {
                        return UI.showError("Configuração Incompleta", "Por favor, cole as credenciais do seu projeto Firebase no ficheiro HTML.");
                    }
                    
                    try {
                        const firebaseApp = initializeApp(USER_FIREBASE_CONFIG);
                        state.db = getFirestore(firebaseApp);
                        state.igrejasCollectionRef = collection(state.db, "igrejas");
                        
                        const auth = getAuth(firebaseApp);
                        signInAnonymously(auth)
                            .then(() => this.onReady())
                            .catch(err => UI.showError("Erro de Autenticação", `Verifique os seus 'Domínios autorizados' no Firebase. Erro: ${err.message}`));
                    } catch (error) {
                        UI.showError("Erro Crítico na Inicialização", `Verifique as credenciais. Detalhe: ${error.message}`);
                    }
                },

                onReady() {
                    this.initMap();
                    this.fetchChurches();
                    this.setupEventListeners();
                },

                initMap() {
                    state.map = L.map('map-container').setView(MAP_CENTER, 8);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(state.map);
                },

                fetchChurches() {
                    onSnapshot(state.igrejasCollectionRef, (snapshot) => {
                        state.allChurches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        UI.updateFilters();
                        this.filterAndRender();
                        UI.hideLoading();
                    }, (error) => {
                        UI.showError("Erro de Permissão", `A sua base de dados bloqueou o acesso. Verifique as suas Regras de Segurança.`);
                    });
                },

                filterAndRender() {
                    const searchTerm = document.getElementById('search-input').value.toLowerCase();
                    const city = document.getElementById('city-filter').value;
                    const neighborhood = document.getElementById('neighborhood-filter').value;

                    state.filteredChurches = state.allChurches.filter(church => {
                        const matchesSearch = !searchTerm || (church.name || '').toLowerCase().includes(searchTerm);
                        const matchesCity = !city || church.city === city;
                        const matchesNeighborhood = !neighborhood || church.neighborhood === neighborhood;
                        return matchesSearch && matchesCity && matchesNeighborhood;
                    }).sort((a,b) => (a.name || '').localeCompare(b.name || ''));
                    
                    UI.renderChurchList(state.filteredChurches);
                    this.renderMarkers();
                },
                
                renderMarkers() {
                    state.map.eachLayer(layer => { if (layer instanceof L.Marker) state.map.removeLayer(layer); });
                    state.filteredChurches.forEach(church => {
                        if (church.coords) {
                            const marker = L.marker(church.coords).addTo(state.map);
                            marker.on('click', () => this.selectChurch(church.id));
                        }
                    });
                },

                selectChurch(id) {
                    const church = state.allChurches.find(c => c.id === id);
                    if (church) {
                        state.selectedChurchId = id;
                        state.map.setView(church.coords, 16);
                        UI.Modals.openDetails(church);
                    }
                },

                setupEventListeners() {
                    document.getElementById('search-input').addEventListener('input', () => this.filterAndRender());
                    document.getElementById('city-filter').addEventListener('change', (e) => {
                        const city = e.target.value;
                        if (city && CIDADES_SC[city]) {
                            state.map.setView([CIDADES_SC[city].lat, CIDADES_SC[city].lon], CIDADES_SC[city].zoom);
                        }
                        UI.updateFilters();
                        this.filterAndRender();
                    });
                    document.getElementById('neighborhood-filter').addEventListener('change', async (e) => {
                        const neighborhood = e.target.value;
                        const city = document.getElementById('city-filter').value;
                        
                        UI.updateFilters(); 

                        if (neighborhood && city) {
                            UI.showLoading('A localizar bairro...');
                            const coords = await API.geocodeAddress(`${neighborhood}, ${city}, Santa Catarina`);
                            UI.hideLoading();
                            if (coords) {
                                state.map.setView([coords.lat, coords.lon], 15);
                            }
                        }
                        this.filterAndRender();
                    });
                    document.getElementById('toggle-panel-btn').addEventListener('click', () => {
                        document.getElementById('side-panel').classList.toggle('hidden-mobile');
                    });
                    document.getElementById('add-church-btn').addEventListener('click', () => UI.Modals.openAddEdit());
                    document.getElementById('admin-btn').addEventListener('click', () => UI.Modals.openAdmin());
                }
            };

            // --- MÓDULO DA UI E MODAIS ---
            const UI = {
                showLoading: (message) => { document.getElementById('loading-overlay').classList.remove('hidden'); document.getElementById('loading-text').textContent = message; },
                hideLoading: () => { state.isLoaded = true; clearTimeout(state.loadingTimeout); document.getElementById('loading-overlay').classList.add('hidden'); },
                showError: (title, message, isTimeout = false) => {
                    clearTimeout(state.loadingTimeout);
                    const overlay = document.getElementById('loading-overlay');
                     if (isTimeout) {
                        const authUrl = `https://console.firebase.google.com/project/${USER_FIREBASE_CONFIG.projectId}/authentication/settings`;
                        message = `A aplicação demorou demasiado tempo a responder. Isto acontece quando o domínio do site não está autorizado.<br><br>
                        <b>1. <a href="${authUrl}" target="_blank" class="text-sky-600 underline font-semibold">Clique aqui para abrir as configurações de autenticação.</a></b><br>
                        2. Clique em "Adicionar domínio" e insira: <b>${window.location.hostname}</b>`;
                    }
                    overlay.innerHTML = `<div class="text-center p-8 max-w-lg mx-auto bg-white rounded-lg shadow-xl border border-red-200"><i class="fa fa-times-circle text-6xl text-red-500"></i><h2 class="mt-4 text-2xl font-bold text-slate-800">${title}</h2><p class="mt-2 text-slate-600 text-left">${message}</p></div>`;
                    overlay.classList.remove('hidden');
                },
                renderChurchList: (churches) => {
                    const listEl = document.getElementById('church-list');
                    const countDisplay = document.getElementById('church-count-display');
                    countDisplay.innerHTML = `A exibir <strong>${churches.length}</strong> de <strong>${state.allChurches.length}</strong> locais.`;

                    listEl.innerHTML = '';
                    if (churches.length === 0) { listEl.innerHTML = `<div class="p-4 text-center text-slate-500">Nenhuma igreja encontrada.</div>`; return; }
                    churches.forEach(church => {
                        const card = document.createElement('div');
                        card.className = 'p-3 border-b border-slate-100 hover:bg-sky-50 cursor-pointer transition';
                        card.dataset.id = church.id;
                        card.innerHTML = `<h3 class="font-semibold text-slate-800">${church.name || 'Igreja sem nome'}</h3><p class="text-sm text-slate-500">${church.address || 'Endereço não informado'}</p>`;
                        card.addEventListener('click', () => {
                            App.selectChurch(church.id);
                            if (window.innerWidth < 768) document.getElementById('side-panel').classList.add('hidden-mobile');
                        });
                        listEl.appendChild(card);
                    });
                },
                updateFilters: () => {
                    const cityFilter = document.getElementById('city-filter');
                    const neiFilter = document.getElementById('neighborhood-filter');
                    const selectedCity = cityFilter.value;
                    const selectedNeighborhood = neiFilter.value;

                    // Cidades
                    if (cityFilter.options.length <= 1) { 
                         cityFilter.innerHTML = '<option value="">Todas as Cidades</option>' + Object.keys(CIDADES_SC).sort().map(c => `<option value="${c}">${c}</option>`).join('');
                    }
                    
                    // Bairros
                    const neighborhoods = BAIRROS_POR_CIDADE[selectedCity] || [];
                    neiFilter.innerHTML = '<option value="">Todos os Bairros</option>' + neighborhoods.map(n => `<option value="${n}">${n}</option>`).join('');
                    if (neighborhoods.includes(selectedNeighborhood)) {
                        neiFilter.value = selectedNeighborhood;
                    }
                    neiFilter.disabled = !selectedCity;
                },
                showToast: (message, isError = false) => {
                    const toastContainer = document.getElementById('toast-container');
                    const toast = document.createElement('div');
                    toast.className = `p-3 rounded-md shadow-md text-white fade-in ${isError ? 'bg-red-500' : 'bg-green-500'}`;
                    toast.textContent = message;
                    toastContainer.appendChild(toast);
                    setTimeout(() => {
                        toast.remove();
                    }, 4000);
                },
                ProgressBar: { /* ... Omitido para brevidade ... */ },
                Modals: {
                    _createModal(id, content, maxWidth = 'max-w-lg') {
                        const modal = document.createElement('div');
                        modal.id = id;
                        modal.className = 'fixed inset-0 bg-black/60 z-40 hidden items-center justify-center p-4 fade-in';
                        modal.innerHTML = `<div class="bg-white rounded-lg shadow-2xl w-full ${maxWidth} flex flex-col max-h-[90vh]">${content}</div>`;
                        document.getElementById('modal-container').appendChild(modal);
                        modal.querySelector('.close-modal-btn')?.addEventListener('click', () => modal.remove());
                        return modal;
                    },
                    openDetails(church) {
                        let scheduleHtml = (church.schedule || []).map(s => {
                            const timeText = s.endTime ? `${s.startTime} - ${s.endTime}` : s.startTime;
                            return `<div class="flex justify-between text-sm py-1.5 border-b border-slate-100"><span class="font-medium text-slate-600">${s.day}</span><span class="text-slate-800">${timeText}</span></div>`;
                        }).join('') || '<p class="text-sm text-slate-500">Horários não informados.</p>';

                        const content = `
                            <header class="p-4 bg-slate-50 rounded-t-lg border-b flex justify-between items-start">
                                <div><h2 class="text-xl font-bold text-slate-900">${church.name}</h2><p class="text-sm text-slate-600">${church.address}</p></div>
                                <button class="close-modal-btn text-2xl text-slate-400 hover:text-slate-800">&times;</button>
                            </header>
                            <div class="p-4 custom-scrollbar overflow-y-auto">
                                <div class="mb-4"><h4 class="font-semibold mb-2">Horários</h4>${scheduleHtml}</div>
                                <div class="mb-4"><h4 class="font-semibold mb-2">Contacto</h4><p class="text-sm text-slate-600"><strong>Líder:</strong> ${church.leader || 'Não informado'}</p><p class="text-sm text-slate-600"><strong>Telefone:</strong> ${church.phone || 'Não informado'}</p><p class="text-sm text-slate-600"><strong>Website:</strong> ${church.website ? `<a href="${church.website}" target="_blank" class="text-sky-600 hover:underline">Visitar</a>` : 'Não informado'}</p></div>
                            </div>
                            <footer class="p-4 border-t flex gap-2">
                                 <a href="https://www.google.com/maps/dir/?api=1&destination=${church.coords[0]},${church.coords[1]}" target="_blank" class="flex-1 text-center bg-sky-600 text-white font-semibold py-2 rounded-md hover:bg-sky-700 transition flex items-center justify-center gap-2"><i class="fa fa-route"></i> Rota</a>
                                 <a href="https://www.google.com/maps?q&layer=c&cbll=${church.coords[0]},${church.coords[1]}" target="_blank" class="flex-1 text-center bg-amber-500 text-white font-semibold py-2 rounded-md hover:bg-amber-600 transition flex items-center justify-center gap-2"><i class="fa fa-street-view"></i> Ver Rua</a>
                                 <button class="edit-btn flex-1 bg-slate-200 font-semibold py-2 rounded-md hover:bg-slate-300">Editar</button>
                            </footer>`;
                        const modal = this._createModal('details-modal', content);
                        modal.classList.remove('hidden');
                        modal.querySelector('.edit-btn').addEventListener('click', () => { modal.remove(); this.openAddEdit(church); });
                    },
                    openAddEdit(church = {}) { /* ... Omitido para brevidade ... */ },
                    openAdmin() {
                        const content = `
                            <header class="p-4 border-b flex justify-between items-center"><h2 class="text-xl font-bold">Ferramentas Administrativas</h2><button class="close-modal-btn text-2xl text-slate-400 hover:text-slate-800">&times;</button></header>
                            <div class="p-4 space-y-3">
                                <button id="report-btn" class="w-full text-left p-3 rounded-md bg-slate-100 hover:bg-slate-200 transition">Relatório de Denominações</button>
                                <button id="import-btn" class="w-full text-left p-3 rounded-md bg-slate-100 hover:bg-slate-200 transition">Assistente de Importação</button>
                                <button id="cleanup-btn" class="w-full text-left p-3 rounded-md bg-slate-100 hover:bg-slate-200 transition">Limpar Locais Fora de SC</button>
                                <button id="clear-all-btn" class="w-full text-left p-3 rounded-md bg-red-50 text-red-700 hover:bg-red-100 transition">Apagar TODA a Base de Dados</button>
                                <button id="test-connection-btn" class="w-full text-left p-3 rounded-md bg-slate-100 hover:bg-slate-200 transition mt-4">Testar Ligação</button>
                            </div>`;
                        const modal = this._createModal('admin-modal', content, 'max-w-md');
                        modal.classList.remove('hidden');
                        modal.querySelector('#report-btn').addEventListener('click', () => { modal.remove(); this.openReport(); });
                        modal.querySelector('#import-btn').addEventListener('click', () => { modal.remove(); this.openImportAssistant(); });
                        modal.querySelector('#cleanup-btn').addEventListener('click', () => { modal.remove(); this.openConfirm({ action: 'cleanup' }); });
                        modal.querySelector('#clear-all-btn').addEventListener('click', () => { modal.remove(); this.openConfirm({ action: 'clearAll' }); });
                        modal.querySelector('#test-connection-btn').addEventListener('click', async () => { UI.showLoading('A testar...'); try { await getDocs(query(state.igrejasCollectionRef, limit(1))); UI.showToast('Ligação com Firebase OK!'); } catch(e) { UI.showToast(`Falha na ligação: ${e.message}`, true); } finally { UI.hideLoading(); }});
                    },
                    openConfirm({ action }) { /* ... Omitido para brevidade ... */ },
                    openImportAssistant() { /* ... Omitido para brevidade ... */ },
                    openReport() { /* ... Omitido para brevidade ... */ }
                }
            };
            
            // --- MÓDULO DE ADMINISTRAÇÃO E API ---
            const Admin = { /* ... Omitido para brevidade ... */ };
            const API = { /* ... Omitido para brevidade ... */ };
            
            // --- INICIALIZAR A APLICAÇÃO ---
            App.init();
        });
    </script>
</body>
</html>

