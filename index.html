<!DOCTYPE html>
<html lang="pt-br" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Igrejas - Blumenau</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body { font-family: 'Poppins', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .slide-in-left { animation: slideInLeft 0.4s cubic-bezier(0.250, 0.460, 0.450, 0.940) both; }
        @keyframes slideInLeft { 0% { transform: translateX(-100%); opacity: 0; } 100% { transform: translateX(0); opacity: 1; } }
        @media (max-width: 768px) {
            #side-panel { transition: transform 0.3s ease-in-out; }
            #side-panel.hidden-mobile { transform: translateX(-100%); }
        }
    </style>
</head>
<body class="h-full bg-slate-50 antialiased overflow-hidden text-slate-800">

    <div id="app-container" class="h-full w-full relative flex">

        <!-- PAINEL LATERAL -->
        <aside id="side-panel" class="absolute md:relative z-20 w-full md:w-[380px] h-full bg-white shadow-lg flex flex-col transition-transform slide-in-left">
            <header class="p-4 border-b border-slate-200 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <i class="fa fa-church text-2xl text-sky-600"></i>
                    <div>
                        <h1 class="text-lg font-bold text-slate-900">Portal de Igrejas</h1>
                        <p class="text-xs text-slate-500">Encontre um lugar de comunidade em Blumenau</p>
                    </div>
                </div>
            </header>

            <div class="p-4 flex-shrink-0 border-b border-slate-200 space-y-3">
                <div class="relative">
                    <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="search-input" placeholder="Pesquisar por nome..." class="w-full bg-slate-100 rounded-md pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
                <div class="flex gap-2">
                    <select id="denomination-filter" class="w-1/2 bg-slate-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
                    <select id="neighborhood-filter" class="w-1/2 bg-slate-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
                </div>
            </div>

            <div id="church-list" class="flex-grow overflow-y-auto custom-scrollbar p-2"></div>

            <footer class="p-4 flex-shrink-0 border-t border-slate-200 flex items-center justify-between">
                <button id="add-church-btn" class="w-full bg-sky-600 text-white font-semibold py-2.5 rounded-md hover:bg-sky-700 transition flex items-center justify-center gap-2">
                    <i class="fa fa-plus"></i> Adicionar Igreja
                </button>
                 <button id="admin-btn" title="Ferramentas Administrativas" class="ml-2 flex-shrink-0 w-10 h-10 bg-slate-200 text-slate-600 rounded-md hover:bg-slate-300 transition flex items-center justify-center">
                    <i class="fa fa-cog"></i>
                </button>
            </footer>
        </aside>

        <!-- MAPA -->
        <main id="map-container" class="flex-grow h-full"></main>
        
        <button id="toggle-panel-btn" class="md:hidden absolute z-30 top-4 left-4 w-10 h-10 bg-white rounded-full shadow-md flex items-center justify-center text-slate-700">
            <i class="fa fa-bars"></i>
        </button>
    </div>
    
    <!-- MODAIS -->
    <div id="modal-container"></div>
    
    <!-- OVERLAY DE CARREGAMENTO -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[9999] flex flex-col items-center justify-center">
        <i class="fa fa-church fa-spin text-5xl text-sky-600"></i>
        <p id="loading-text" class="mt-4 text-slate-700 font-semibold">A carregar o portal...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, setDoc, deleteDoc, doc, getDocs, query, limit, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {

            const USER_FIREBASE_CONFIG = {
                apiKey: "AIzaSyDXmAZ-VW7Ti1_L5GPW0gNBkfGxMmxvypQ",
                authDomain: "controle-de-igrejas.firebaseapp.com",
                projectId: "controle-de-igrejas",
                storageBucket: "controle-de-igrejas.firebasestorage.app",
                messagingSenderId: "457376397325",
                appId: "1:457376397325:web:aacc6cef3e91390314fd44",
                measurementId: "G-PENC7PPT4M"
            };
            
            const ADMIN_PASSWORD = "2308";
            const MAP_CENTER = [-26.9194, -49.0661];
            const DENOMINATIONS = ['Católica', 'Luterana', 'Batista', 'Assembleia de Deus', 'Outra Evangélica', 'Outra'];

            let state = { allChurches: [], map: null, db: null, igrejasCollectionRef: null, selectedChurchId: null, isLoaded: false, loadingTimeout: null };

            // --- MÓDULO PRINCIPAL ---
            const App = {
                init() {
                    UI.showLoading('A inicializar...');
                    state.loadingTimeout = setTimeout(() => {
                        if (!state.isLoaded) UI.showError('A aplicação demorou a responder', '', true);
                    }, 10000);

                    if (!USER_FIREBASE_CONFIG?.apiKey) {
                        return UI.showError("Configuração Incompleta", "Por favor, cole as credenciais do seu projeto Firebase no ficheiro HTML.");
                    }
                    
                    try {
                        const firebaseApp = initializeApp(USER_FIREBASE_CONFIG);
                        state.db = getFirestore(firebaseApp);
                        state.igrejasCollectionRef = collection(state.db, "igrejas");
                        
                        const auth = getAuth(firebaseApp);
                        signInAnonymously(auth)
                            .then(() => this.onReady())
                            .catch(err => UI.showError("Erro de Autenticação", `Verifique os seus 'Domínios autorizados' no Firebase. Erro: ${err.message}`));
                    } catch (error) {
                        UI.showError("Erro Crítico na Inicialização", `Verifique as credenciais. Detalhe: ${error.message}`);
                    }
                },

                onReady() {
                    this.initMap();
                    this.fetchChurches();
                    this.setupEventListeners();
                },

                initMap() {
                    state.map = L.map('map-container').setView(MAP_CENTER, 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(state.map);
                },

                fetchChurches() {
                    onSnapshot(state.igrejasCollectionRef, (snapshot) => {
                        state.allChurches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        this.filterAndRender();
                        UI.updateFilters(state.allChurches);
                        this.renderMarkers();
                        UI.hideLoading();
                    }, (error) => {
                        UI.showError("Erro de Permissão", `A sua base de dados bloqueou o acesso. Verifique as suas Regras de Segurança.`);
                    });
                },

                filterAndRender() {
                    const searchTerm = document.getElementById('search-input').value.toLowerCase();
                    const denomination = document.getElementById('denomination-filter').value;
                    const neighborhood = document.getElementById('neighborhood-filter').value;

                    const filtered = state.allChurches.filter(church => {
                        const matchesSearch = !searchTerm || (church.name || '').toLowerCase().includes(searchTerm);
                        const matchesDenomination = !denomination || church.denomination === denomination;
                        const matchesNeighborhood = !neighborhood || church.neighborhood === neighborhood;
                        return matchesSearch && matchesDenomination && matchesNeighborhood;
                    }).sort((a,b) => (a.name || '').localeCompare(b.name || ''));
                    
                    UI.renderChurchList(filtered);
                },
                
                renderMarkers() {
                    state.map.eachLayer(layer => { if (layer instanceof L.Marker) state.map.removeLayer(layer); });
                    state.allChurches.forEach(church => {
                        if (church.coords) {
                            const marker = L.marker(church.coords).addTo(state.map);
                            marker.on('click', () => this.selectChurch(church.id));
                        }
                    });
                },

                selectChurch(id) {
                    const church = state.allChurches.find(c => c.id === id);
                    if (church) {
                        state.selectedChurchId = id;
                        state.map.setView(church.coords, 16);
                        UI.Modals.openDetails(church);
                    }
                },

                setupEventListeners() {
                    document.getElementById('search-input').addEventListener('input', () => this.filterAndRender());
                    document.getElementById('denomination-filter').addEventListener('change', () => this.filterAndRender());
                    document.getElementById('neighborhood-filter').addEventListener('change', () => this.filterAndRender());
                    document.getElementById('toggle-panel-btn').addEventListener('click', () => {
                        document.getElementById('side-panel').classList.toggle('hidden-mobile');
                    });
                    document.getElementById('add-church-btn').addEventListener('click', () => UI.Modals.openAddEdit());
                    document.getElementById('admin-btn').addEventListener('click', () => UI.Modals.openAdmin());
                }
            };

            // --- MÓDULO DA UI E MODAIS ---
            const UI = {
                showLoading: (message) => { document.getElementById('loading-overlay').classList.remove('hidden'); document.getElementById('loading-text').textContent = message; },
                hideLoading: () => { state.isLoaded = true; clearTimeout(state.loadingTimeout); document.getElementById('loading-overlay').classList.add('hidden'); },
                showError: (title, message, isTimeout = false) => {
                    clearTimeout(state.loadingTimeout);
                    const overlay = document.getElementById('loading-overlay');
                     if (isTimeout) {
                        const authUrl = `https://console.firebase.google.com/project/${USER_FIREBASE_CONFIG.projectId}/authentication/settings`;
                        message = `A aplicação demorou demasiado tempo a responder. Isto acontece quando o domínio do site não está autorizado.<br><br>
                        <b>1. <a href="${authUrl}" target="_blank" class="text-sky-600 underline font-semibold">Clique aqui para abrir as configurações de autenticação.</a></b><br>
                        2. Clique em "Adicionar domínio" e insira: <b>${window.location.hostname}</b>`;
                    }
                    overlay.innerHTML = `<div class="text-center p-8 max-w-lg mx-auto bg-white rounded-lg shadow-xl border border-red-200"><i class="fa fa-times-circle text-6xl text-red-500"></i><h2 class="mt-4 text-2xl font-bold text-slate-800">${title}</h2><p class="mt-2 text-slate-600 text-left">${message}</p></div>`;
                    overlay.classList.remove('hidden');
                },
                renderChurchList: (churches) => {
                    const listEl = document.getElementById('church-list');
                    listEl.innerHTML = '';
                    if (churches.length === 0) { listEl.innerHTML = `<div class="p-4 text-center text-slate-500">Nenhuma igreja encontrada.</div>`; return; }
                    churches.forEach(church => {
                        const card = document.createElement('div');
                        card.className = 'p-3 border-b border-slate-100 hover:bg-sky-50 cursor-pointer transition';
                        card.dataset.id = church.id;
                        card.innerHTML = `<h3 class="font-semibold text-slate-800">${church.name || 'Igreja sem nome'}</h3><p class="text-sm text-slate-500">${church.address || 'Endereço não informado'}</p>`;
                        card.addEventListener('click', () => {
                            App.selectChurch(church.id);
                            if (window.innerWidth < 768) document.getElementById('side-panel').classList.add('hidden-mobile');
                        });
                        listEl.appendChild(card);
                    });
                },
                updateFilters: (churches) => {
                    const denFilter = document.getElementById('denomination-filter');
                    const neiFilter = document.getElementById('neighborhood-filter');
                    const denominations = [...new Set(churches.map(c => c.denomination).filter(Boolean))].sort();
                    const neighborhoods = [...new Set(churches.map(c => c.neighborhood).filter(Boolean))].sort();
                    denFilter.innerHTML = '<option value="">Todas as Denominações</option>' + denominations.map(d => `<option value="${d}">${d}</option>`).join('');
                    neiFilter.innerHTML = '<option value="">Todos os Bairros</option>' + neighborhoods.map(n => `<option value="${n}">${n}</option>`).join('');
                },
                Modals: {
                    _createModal(id, content) {
                        const modal = document.createElement('div');
                        modal.id = id;
                        modal.className = 'fixed inset-0 bg-black/60 z-40 hidden items-center justify-center p-4 fade-in';
                        modal.innerHTML = content;
                        document.getElementById('modal-container').appendChild(modal);
                        modal.querySelector('.close-modal-btn')?.addEventListener('click', () => modal.classList.add('hidden'));
                        return modal;
                    },
                    openDetails(church) {
                        let modal = document.getElementById('details-modal');
                        let scheduleHtml = (church.schedule || []).map(s => `<div class="flex justify-between text-sm py-1.5 border-b border-slate-100"><span class="font-medium text-slate-600">${s.day}</span><span class="text-slate-800">${s.time}</span></div>`).join('') || '<p class="text-sm text-slate-500">Horários não informados.</p>';

                        const content = `
                            <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]">
                                <header class="p-4 bg-slate-50 rounded-t-lg border-b flex justify-between items-start">
                                    <div><h2 class="text-xl font-bold text-slate-900">${church.name}</h2><p class="text-sm text-slate-600">${church.address}</p></div>
                                    <button class="close-modal-btn text-2xl text-slate-400 hover:text-slate-800">&times;</button>
                                </header>
                                <div class="p-4 custom-scrollbar overflow-y-auto">
                                    <div class="mb-4"><h4 class="font-semibold mb-2">Horários</h4>${scheduleHtml}</div>
                                    <div class="mb-4"><h4 class="font-semibold mb-2">Contacto</h4><p class="text-sm text-slate-600"><strong>Líder:</strong> ${church.leader || 'Não informado'}</p><p class="text-sm text-slate-600"><strong>Telefone:</strong> ${church.phone || 'Não informado'}</p><p class="text-sm text-slate-600"><strong>Website:</strong> ${church.website ? `<a href="${church.website}" target="_blank" class="text-sky-600 hover:underline">Visitar</a>` : 'Não informado'}</p></div>
                                </div>
                                <footer class="p-4 border-t flex gap-2">
                                     <a href="https://www.google.com/maps/dir/?api=1&destination=${church.coords[0]},${church.coords[1]}" target="_blank" class="flex-1 text-center bg-sky-600 text-white font-semibold py-2 rounded-md hover:bg-sky-700 transition">Obter Rota</a>
                                     <button data-id="${church.id}" class="edit-btn flex-1 bg-slate-200 font-semibold py-2 rounded-md hover:bg-slate-300">Editar</button>
                                </footer>
                            </div>`;
                        if (modal) modal.remove();
                        modal = this._createModal('details-modal', content);
                        modal.classList.remove('hidden');
                        modal.querySelector('.edit-btn').addEventListener('click', () => { this.openAddEdit(church); });
                    },
                    openAddEdit(church = {}) {
                        const isEditing = !!church.id;
                        const modalId = 'add-edit-modal';
                        let modal = document.getElementById(modalId);
                        const scheduleHtml = (church.schedule || [{day: '', time: ''}]).map((s, i) => `
                            <div class="flex items-center gap-2 schedule-row">
                                <input type="text" value="${s.day}" placeholder="Dia (ex: Domingo)" class="w-1/2 border-slate-300 rounded-md text-sm schedule-day">
                                <input type="text" value="${s.time}" placeholder="Horário (ex: 19:30)" class="w-1/2 border-slate-300 rounded-md text-sm schedule-time">
                                <button type="button" class="${i === 0 ? 'add-schedule-btn' : 'remove-schedule-btn'} text-sm">${i === 0 ? '<i class="fa fa-plus text-green-500"></i>' : '<i class="fa fa-trash text-red-500"></i>'}</button>
                            </div>
                        `).join('');

                        const content = `
                            <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]">
                                <header class="p-4"><h2 class="text-xl font-bold">${isEditing ? 'Editar' : 'Adicionar'} Igreja</h2></header>
                                <div class="p-4 custom-scrollbar overflow-y-auto space-y-4">
                                    <div><label class="text-sm font-medium">Nome*</label><input id="form-name" type="text" class="w-full border-slate-300 rounded-md" value="${church.name || ''}"></div>
                                    <div><label class="text-sm font-medium">Endereço</label><input id="form-address" type="text" class="w-full border-slate-300 rounded-md" value="${church.address || ''}"></div>
                                    <div><label class="text-sm font-medium">Bairro</label><input id="form-neighborhood" type="text" class="w-full border-slate-300 rounded-md" value="${church.neighborhood || ''}"></div>
                                    <div><label class="text-sm font-medium">Denominação</label><select id="form-denomination" class="w-full border-slate-300 rounded-md">${DENOMINATIONS.map(d => `<option value="${d}" ${church.denomination === d ? 'selected' : ''}>${d}</option>`)}</select></div>
                                    <div><label class="text-sm font-medium">Horários</label><div id="schedule-container" class="space-y-2">${scheduleHtml}</div></div>
                                    <div><label class="text-sm font-medium">Líder</label><input id="form-leader" type="text" class="w-full border-slate-300 rounded-md" value="${church.leader || ''}"></div>
                                    <div><label class="text-sm font-medium">Telefone</label><input id="form-phone" type="text" class="w-full border-slate-300 rounded-md" value="${church.phone || ''}"></div>
                                    <div><label class="text-sm font-medium">Website</label><input id="form-website" type="text" class="w-full border-slate-300 rounded-md" value="${church.website || ''}"></div>
                                    <div><label class="text-sm font-medium">Localização* (Clique no mapa)</label><div id="form-map" class="h-48 rounded-md"></div><input id="form-lat" type="hidden" value="${church.coords?.[0] || ''}"><input id="form-lng" type="hidden" value="${church.coords?.[1] || ''}"></div>
                                </div>
                                <footer class="p-4 border-t flex justify-end gap-2">
                                    <button class="close-modal-btn bg-slate-200 font-semibold py-2 px-4 rounded-md">Cancelar</button>
                                    <button id="save-btn" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-md">Salvar</button>
                                </footer>
                            </div>`;
                        if (modal) modal.remove();
                        modal = this._createModal(modalId, content);
                        modal.classList.remove('hidden');

                        const formMap = L.map('form-map').setView(church.coords || MAP_CENTER, 15);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(formMap);
                        let marker = church.coords ? L.marker(church.coords).addTo(formMap) : null;
                        formMap.on('click', e => {
                            document.getElementById('form-lat').value = e.latlng.lat;
                            document.getElementById('form-lng').value = e.latlng.lng;
                            if (marker) marker.setLatLng(e.latlng);
                            else marker = L.marker(e.latlng).addTo(formMap);
                        });
                        
                        document.getElementById('schedule-container').addEventListener('click', e => {
                            if (e.target.closest('.add-schedule-btn')) {
                                const container = document.getElementById('schedule-container');
                                const newRow = container.querySelector('.schedule-row').cloneNode(true);
                                newRow.querySelectorAll('input').forEach(i => i.value = '');
                                newRow.querySelector('button').innerHTML = '<i class="fa fa-trash text-red-500"></i>';
                                newRow.querySelector('button').classList.replace('add-schedule-btn', 'remove-schedule-btn');
                                container.appendChild(newRow);
                            } else if (e.target.closest('.remove-schedule-btn')) {
                                e.target.closest('.schedule-row').remove();
                            }
                        });

                        document.getElementById('save-btn').addEventListener('click', async () => {
                            const lat = parseFloat(document.getElementById('form-lat').value);
                            const lng = parseFloat(document.getElementById('form-lng').value);
                            const schedule = [...document.querySelectorAll('.schedule-row')].map(row => ({
                                day: row.querySelector('.schedule-day').value,
                                time: row.querySelector('.schedule-time').value
                            })).filter(s => s.day && s.time);

                            const data = {
                                name: document.getElementById('form-name').value,
                                address: document.getElementById('form-address').value,
                                neighborhood: document.getElementById('form-neighborhood').value,
                                denomination: document.getElementById('form-denomination').value,
                                schedule: schedule,
                                leader: document.getElementById('form-leader').value,
                                phone: document.getElementById('form-phone').value,
                                website: document.getElementById('form-website').value,
                                coords: (lat && lng) ? [lat, lng] : null
                            };
                            
                            UI.showLoading('A salvar...');
                            try {
                                if (isEditing) await setDoc(doc(state.igrejasCollectionRef, church.id), data);
                                else await addDoc(state.igrejasCollectionRef, data);
                                modal.classList.add('hidden');
                            } catch (err) { alert('Erro ao salvar.'); } finally { UI.hideLoading(); }
                        });
                    },
                    openAdmin() { /* ... */ },
                    openConfirm() { /* ... */ }
                }
            };
            
            // --- INICIALIZAR A APLICAÇÃO ---
            App.init();
        });
    </script>
</body>
</html>

