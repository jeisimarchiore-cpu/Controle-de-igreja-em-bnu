<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Igrejas de Blumenau</title>

    <!-- 1. Incluindo a biblioteca Leaflet.js (CSS e JS) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    
    <!-- Incluindo o plugin Leaflet.awesome-markers para ícones melhores -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>
    
    <!-- Font Awesome para os ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


    <style>
        /* 2. Estilo para o mapa e o corpo da página */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 100%;
            width: 100%;
            cursor: grab;
        }
        /* Estilo customizado para a popup */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .leaflet-popup-content h3 {
            margin: 0 0 10px;
            color: #333;
            font-size: 1.1em;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .leaflet-popup-content p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #555;
        }
        .leaflet-popup-content a {
            color: #007bff;
            text-decoration: none;
        }
        .popup-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }
        .popup-btn {
            padding: 5px 10px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .popup-edit-btn { background-color: #ffc107; color: #333; }
        .popup-delete-btn { background-color: #dc3545; }
        
        /* Estilos para o painel de adição/edição */
        #side-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            width: 320px;
            max-height: 90%;
            overflow-y: auto;
        }
        #side-panel h3 { margin-top: 0; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .form-group input, .form-group select { width: 95%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .input-group { display: flex; align-items: center; }
        .input-group input { flex-grow: 1; }
        .input-group button { margin-left: 5px; padding: 8px 12px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; }
        
        /* Estilos para a nova grade de horários */
        .schedule-day { display: flex; flex-direction: column; margin-bottom: 8px; }
        .schedule-day-label { font-weight: bold; display: flex; align-items: center; }
        .schedule-day-label input[type="checkbox"] { margin-right: 8px; width: auto; }
        .schedule-day-fields { padding-left: 26px; display: none; }
        .schedule-day-fields.active { display: block; }
        .schedule-day-fields input, .schedule-day-fields select { width: 95%; padding: 6px; font-size: 0.9em; margin-bottom: 5px; }
        .time-fields { display: flex; align-items: center; gap: 5px; }
        .time-fields select { width: auto; flex-grow: 1; }

        #save-church-btn { width: 100%; padding: 10px; color: white; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; transition: background-color 0.3s; }
        #cancel-edit-btn { width: 100%; padding: 10px; margin-top: 5px; background-color: #6c757d; color: white; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; }
        #message-area, #import-message-area, #cep-message-area { margin-top: 5px; font-size: 0.9em; color: #28a745; height: 1.2em; }
        #message-area.error, #import-message-area.error, #cep-message-area.error { color: #dc3545; }
        hr { border: none; border-top: 1px solid #eee; margin: 15px 0; }

        #church-counter { position: absolute; bottom: 20px; left: 20px; z-index: 999; background: rgba(255, 255, 255, 0.9); padding: 8px 15px; border-radius: 8px; font-size: 1.1em; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); cursor: pointer; }

        /* Estilos para Modais */
        .modal-overlay { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; position: relative; text-align: center; }
        .modal-close-btn { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        #church-list-content h4 { margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #007bff; padding-bottom: 5px; color: #007bff; }
        #church-list-content ul { list-style-type: none; padding: 0; }
        #church-list-content li { padding: 8px; border-bottom: 1px solid #ddd; cursor: pointer; }
        #church-list-content li:hover { background-color: #f1f1f1; }
        #confirm-modal .modal-content { max-width: 400px; }
        .modal-buttons { margin-top: 20px; }
        .modal-buttons button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 0 10px; }
        #confirm-delete-btn { background-color: #dc3545; color: white; }
        #cancel-delete-btn { background-color: #6c757d; color: white; }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="church-counter">Carregando igrejas...</div>

    <!-- Modal Lista de Igrejas -->
    <div id="church-list-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h2>Lista de Igrejas por Bairro</h2>
            <div id="church-list-content"></div>
        </div>
    </div>
    
    <!-- Modal de Confirmação de Exclusão -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h3>Confirmar Exclusão</h3>
            <p id="confirm-message"></p>
            <div class="modal-buttons">
                <button id="confirm-delete-btn">Sim, Excluir</button>
                <button id="cancel-delete-btn">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="side-panel">
        <h3 id="panel-title">Adicionar Nova Igreja</h3>
        <div class="form-group"><label for="gmaps-url">Importar do Google Maps</label><div class="input-group"><input type="url" id="gmaps-url" placeholder="Cole o link do Google Maps aqui"><button type="button" id="import-gmaps-btn" title="Importar dados do link"><i class="fa fa-download"></i></button></div><div id="import-message-area"></div></div>
        <hr>
        <p id="coords-info" style="font-size: 0.9em; color: #555; margin-bottom: 15px;">Clique no mapa ou use o endereço/CEP para localizar.</p>
        <form id="church-form"><div class="form-group"><label for="church-name">Nome da Igreja</label><input type="text" id="church-name" required></div><div class="form-group"><label for="church-pastor">Líder / Pastor / Padre</label><input type="text" id="church-pastor"></div><div class="form-group"><label for="church-cep">CEP</label><input type="text" id="church-cep" placeholder="Digite os 8 dígitos do CEP"><div id="cep-message-area"></div></div><div class="form-group"><label for="church-numero">Número</label><input type="text" id="church-numero"></div><div class="form-group"><label for="church-bairro">Bairro</label><input type="text" id="church-bairro"></div><div class="form-group"><label for="church-endereco">Endereço Completo</label><div class="input-group"><input type="text" id="church-endereco"><button type="button" id="lookup-address-btn" title="Localizar endereço no mapa"><i class="fa fa-map-marker-alt"></i></button></div></div><div class="form-group"><label>Horários e Atividades</label><div id="horarios-container"></div></div><div class="form-group"><label for="church-contato">Telefone Fixo</label><input type="text" id="church-contato"></div><div class="form-group"><label for="church-whatsapp">WhatsApp</label><input type="text" id="church-whatsapp" placeholder="(47) 9....-...."></div><div class="form-group"><label for="church-redes">Rede Social (URL)</label><input type="url" id="church-redes"></div><div class="form-group" style="display: none;"><label>Coordenadas</label><input type="text" id="church-coords-lat" placeholder="Latitude" readonly><input type="text" id="church-coords-lng" placeholder="Longitude" readonly></div><button type="button" id="save-church-btn">Adicionar Igreja</button><button type="button" id="cancel-edit-btn" style="display: none;">Cancelar Edição</button><div id="message-area"></div></form>
    </div>


    <script type="module">
        // Importar funções do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, setDoc, deleteDoc, doc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais da aplicação
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mapa-igrejas-blumenau-dev';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEV", authDomain: "DEV", projectId: "DEV" };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug');

        const igrejasCollectionPath = `/artifacts/${appId}/public/data/igrejas`;
        const igrejasCollection = collection(db, igrejasCollectionPath);

        // MAPA E ESTADO DA APLICAÇÃO
        const centroBlumenau = [-26.9194, -49.0661];
        const zoomInicial = 13;
        const map = L.map('map').setView(centroBlumenau, zoomInicial);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>' }).addTo(map);
        const iconeIgreja = L.AwesomeMarkers.icon({ icon: 'church', markerColor: 'darkred', prefix: 'fa' });
        const iconeTemporario = L.AwesomeMarkers.icon({ icon: 'plus', markerColor: 'blue', prefix: 'fa' });

        const camadaIgrejas = L.layerGroup().addTo(map);
        const diasDaSemana = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
        
        let igrejas = [];
        let marcadorTemporario = null;
        let idEmEdicao = null;
        let ruaDoCep = '';
        let markers = [];

        // FUNÇÕES PRINCIPAIS
        function updateChurchCount() { document.getElementById('church-counter').innerHTML = `<i class="fa fa-church"></i> Total de Igrejas: <strong>${igrejas.length}</strong>`; }
        function showMessage(elementId, message, isError = false) { const el = document.getElementById(elementId); el.textContent = message; el.classList.toggle('error', isError); }

        function redesenharTodosOsMarcadores() {
            camadaIgrejas.clearLayers();
            markers = [];
            igrejas.forEach((igreja) => {
                const marcador = L.marker(igreja.coords, { icon: iconeIgreja }).addTo(camadaIgrejas);
                let conteudoPopup = `<h3>${igreja.nome}</h3>`;
                if (igreja.pastor) conteudoPopup += `<p><strong>Líder:</strong> ${igreja.pastor}</p>`;
                conteudoPopup += `<p><strong>Endereço:</strong> ${igreja.endereco || 'Não informado'}</p>`;
                if (igreja.horarios && igreja.horarios.length > 0) { /* ... (código omitido para brevidade) ... */ }
                if (igreja.contato) conteudoPopup += `<p><strong>Telefone:</strong> ${igreja.contato}</p>`;
                if (igreja.whatsapp) conteudoPopup += `<p><strong>WhatsApp:</strong> ${igreja.whatsapp}</p>`;
                if (igreja.redes_sociais) conteudoPopup += `<p><a href="${igreja.redes_sociais}" target="_blank">Visitar Rede Social</a></p>`;
                conteudoPopup += `<div class="popup-actions"><button class="popup-btn popup-edit-btn" onclick="window.iniciarEdicao('${igreja.id}')">Editar</button><button class="popup-btn popup-delete-btn" onclick="window.confirmarExclusao('${igreja.id}', '${igreja.nome.replace(/'/g, "\\'")}')">Excluir</button></div>`;
                marcador.bindPopup(conteudoPopup);
                marcador.churchId = igreja.id;
                markers.push(marcador);
            });
            updateChurchCount();
        }

        window.iniciarEdicao = (id) => {
            const igreja = igrejas.find(i => i.id === id);
            if (!igreja) return;
            idEmEdicao = id;
            // Preencher formulário (código omitido para brevidade)
            document.getElementById('panel-title').textContent = 'Editar Igreja';
            document.getElementById('save-church-btn').textContent = 'Salvar Alterações';
            document.getElementById('save-church-btn').style.backgroundColor = '#ffc107';
            document.getElementById('cancel-edit-btn').style.display = 'block';
            map.closePopup();
        };

        window.confirmarExclusao = (id, nome) => {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-message').textContent = `Tem certeza que deseja excluir a igreja "${nome}"?`;
            modal.style.display = 'block';

            document.getElementById('confirm-delete-btn').onclick = async () => {
                try {
                    await deleteDoc(doc(db, igrejasCollectionPath, id));
                    alert("Igreja excluída com sucesso!");
                } catch (error) {
                    console.error("Erro ao excluir: ", error);
                    alert("Falha ao excluir a igreja.");
                } finally {
                    modal.style.display = 'none';
                }
            };
            document.getElementById('cancel-delete-btn').onclick = () => { modal.style.display = 'none'; };
            modal.querySelector('.modal-close-btn').onclick = () => { modal.style.display = 'none'; };
        };

        function resetarPainel() {
            idEmEdicao = null;
            // Resetar formulário (código omitido para brevidade)
        }

        // ... (outras funções e listeners como setLocationOnMap, geocodeAddress, etc.)

        // --- LÓGICA DO FIREBASE ---
        async function main() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Autenticado com sucesso. User UID:", auth.currentUser.uid);

                onSnapshot(igrejasCollection, (snapshot) => {
                    igrejas = [];
                    snapshot.forEach((doc) => {
                        igrejas.push({ id: doc.id, ...doc.data() });
                    });
                    console.log("Dados recebidos do Firestore:", igrejas.length, "igrejas.");
                    redesenharTodosOsMarcadores();
                }, (error) => {
                    console.error("Erro ao buscar dados do Firestore: ", error);
                    document.getElementById('church-counter').textContent = 'Erro ao carregar dados.';
                });

            } catch (error) {
                console.error("Erro na autenticação ou inicialização do Firebase:", error);
                document.getElementById('church-counter').textContent = 'Erro de conexão.';
            }
        }
        
        // ... (Listeners de botões como 'save-church-btn' devem agora usar addDoc ou setDoc)
        document.getElementById('save-church-btn').addEventListener('click', async function() {
            // Coletar dados do formulário
            const dadosIgreja = { /* ... */ };
            
            this.textContent = 'Salvando...'; this.disabled = true;
            try {
                if (idEmEdicao) {
                    await setDoc(doc(db, igrejasCollectionPath, idEmEdicao), dadosIgreja);
                    alert('Igreja atualizada com sucesso!');
                } else {
                    await addDoc(igrejasCollection, dadosIgreja);
                    alert('Igreja adicionada com sucesso!');
                }
                resetarPainel();
            } catch (error) {
                console.error("Erro ao salvar no Firestore: ", error);
                alert("Erro ao salvar. Tente novamente.");
            } finally {
                this.disabled = false;
            }
        });

        // Inicialização
        main();
        // ... (Restante do código de inicialização e listeners)
    </script>
</body>
</html>

